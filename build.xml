<project name="LWJGL" basedir="." default="all">

	<property name="build.sysclasspath" value="ignore"/>

	<import file="config/build-definitions.xml"/>

	<!--<taskdef resource="org/jetbrains/jet/buildtools/ant/antlib.xml" classpath="${kotlinc}/kotlin-ant.jar"/>-->
	<taskdef resource="testngtasks" classpath="libs/testng.jar"/>

	<!-- Initialize build -->
	<target name="-initialize" description="Initializes the directories required by the build process.">
		<mkdir dir="${lwjgl.bin.core}" taskname="Core"/>
		<mkdir dir="${lwjgl.bin.util}" taskname="Utilities"/>
		<mkdir dir="${lwjgl.bin.templates}" taskname="Templates"/>
		<mkdir dir="${lwjgl.bin.tests}" taskname="Tests"/>
		<mkdir dir="${lwjgl.bin.native}" taskname="bin"/>
	</target>

	<!-- Cleans up any files created during the execution of this script -->
	<target name="clean" description="Cleans all directories controlled by this ant script" depends="clean-java, clean-native, clean-generated">
		<delete dir="${lwjgl.bin}"/>
	</target>

	<target name="clean-generated" description="Cleans source files generated by this ant script" depends="clean-generated-java,clean-generated-native">
		<!-- We track the generated directory in a separate repo, so don't delete. -->
		<!--<delete dir="${lwjgl.generated}"/>-->
	</target>

	<!-- Cleans up any non-native files created during the execution of this script -->
	<target name="clean-java" description="Cleans non-native files generated by this ant script" depends="clean-generated-java">
		<!-- Delete java classes only to avoid unnecessary native recompilation -->
		<delete dir="${lwjgl.bin.core}"/>
		<delete dir="${lwjgl.bin.util}"/>
		<delete dir="${lwjgl.bin.templates}"/>
		<delete dir="${lwjgl.bin.tests}"/>
	</target>

	<target name="clean-generated-java" description="Cleans Java source files generated by this ant script">
		<delete dir="${lwjgl.generated}/java"/>
	</target>

	<!-- Useful when we need to force native recompilation -->
	<target name="clean-native" description="Cleans native binary files generated by this ant script">
		<delete dir="${lwjgl.bin.native}"/>
	</target>

	<target name="clean-generated-native" description="Cleans native source files generated by this ant script">
		<delete dir="${lwjgl.generated}/native"/>
	</target>

	<target name="all">
		<antcall target="compile-templates"/>
		<antcall target="tests"/>
	</target>

	<target name="compile-templates" description="Compiles the Templates module" depends="-initialize">
		<javac debug="yes" destdir="${lwjgl.bin}/Templates" encoding="utf8" source="1.6" target="1.6" bootclasspathref="java6.boot.classpath" taskname="Java dependencies compilation">
			<src path="${lwjgl.src.templates}"/>
			<include name="org/lwjgl/**"/>
		</javac>

		<java
			classname="org.jetbrains.jet.cli.jvm.K2JVMCompiler"
			fork="true"
		    failonerror="true"
		    taskname="Compiling Templates module"
		>
			<classpath>
				<pathelement path="${kotlinc}/kotlin-compiler.jar"/>
			</classpath>

			<jvmarg value="-server"/>

			<arg value="-module"/>
			<arg value="config/Templates.kts"/>
			<arg value="-output"/>
			<arg value="${lwjgl.bin.templates}"/>
			<!--<arg value="-tags"/>-->
			<!--<arg value="-noStdlib"/>-->
			<!--<arg value="-noJdkAnnotations"/>-->
			<!--<arg value="-noJdk"/>-->
		</java>
		<!--<kotlinc module="config/Templates.kts" jar="${lwjgl.lib}/templates.jar" />-->
	</target>

	<target name="formatter" description="Runs the template formatter tool" depends="-initialize"> <!-- Removed "compile-templates" until Kotlin adds support for incremental compilation -->
		<javac debug="yes" destdir="${lwjgl.bin}/Templates" encoding="utf8" source="1.6" target="1.6" bootclasspathref="java6.boot.classpath" taskname="Java dependencies compilation">
			<src path="${lwjgl.src.templates}"/>
			<include name="org/lwjgl/**"/>
		</javac>

		<java
			classname="org.lwjgl.generator.util.TemplateFormatter"
			fork="true"
			spawn="true"
			>
			<classpath>
				<pathelement path="${lwjgl.bin.templates}"/>
				<pathelement path="${lwjgl.res}"/>
			</classpath>
		</java>
	</target>

	<target name="generate" description="Runs the code Generator" depends="-initialize"> <!-- Removed "compile-templates" until Kotlin adds support for incremental compilation -->
		<java
			classname="org.lwjgl.generator.GeneratorPackage"
			fork="true"
			failonerror="true"
			taskname="Generating code"
			>
			<classpath>
				<pathelement path="${lwjgl.bin.templates}"/>
				<pathelement path="${kotlinc}/kotlin-runtime.jar"/>
			</classpath>

			<jvmarg value="-server"/>
		</java>
	</target>

	<target name="compile" description="Compiles the Java source code" depends="generate">
		<javac debug="yes" destdir="${lwjgl.bin}/Core" encoding="utf8" source="1.6" target="1.6" bootclasspathref="java6.boot.classpath" taskname="Core java compilation" >
			<src path="${lwjgl.src.core}"/>
            <src path="${lwjgl.src.util}/"/>
			<src path="${lwjgl.generated.java}"/>
			<include name="org/lwjgl/**"/>
			<compilerarg value="-XDignore.symbol.file=true"/> <!-- Supresses internal API (e.g. Unsafe) usage warnings -->
		</javac>
	</target>

	<target name="compile-native" depends="-initialize, compile" description="Compiles the native source code">
		<antcall target="-compile_native_linux"/>
		<antcall target="-compile_native_macosx"/>
		<antcall target="-compile_native_windows"/>
	</target>

	<target name="-compile_native_linux" if="lwjgl.platform.linux">
		<ant antfile="config/linux/build.xml" inheritAll="false"/>
		<copy todir="${lwjgl.lib}/linux">
			<fileset dir="${lwjgl.bin.native}" includes="liblwjgl*.so"/>
		</copy>
	</target>

	<target name="-compile_native_macosx" if="lwjgl.platform.macosx">
		<ant antfile="config/macosx/build.xml" inheritAll="false"/>
		<copy todir="${lwjgl.lib}/macosx">
			<fileset dir="${lwjgl.bin.native}" includes="liblwjgl*.jnilib"/>
		</copy>
	</target>

	<target name="-compile_native_windows" if="lwjgl.platform.windows">
		<ant antfile="config/windows/build.xml" inheritAll="false"/>
		<copy todir="${lwjgl.lib}/windows">
			<fileset dir="${lwjgl.bin.native}" includes="lwjgl*.dll"/>
		</copy>
	</target>

	<target name="compile-tests" description="Compiles the LWJGL test suite" depends="compile">
		<javac debug="yes" destdir="${lwjgl.bin}/Tests" encoding="utf8" source="1.6" target="1.6" bootclasspathref="java6.boot.classpath" taskname="Tests compilation">
			<classpath>
				<pathelement path="${lwjgl.bin.core}"/>
				<pathelement path="${lwjgl.bin.util}"/>
				<pathelement path="${lwjgl.lib}/testng.jar"/>
			</classpath>

			<src path="${lwjgl.src}/tests/"/>
			<include name="org/lwjgl/**"/>
		</javac>
	</target>

	<target name="tests" description="Runs the LWJGL test suite" depends="compile-tests, compile-native">
		<testng outputDir="${lwjgl.tests.output}">
			<classpath>
				<pathelement path="${lwjgl.lib}/jcommander.jar"/>
				<pathelement path="${lwjgl.bin.core}"/>
				<pathelement path="${lwjgl.bin.util}"/>
				<pathelement path="${lwjgl.res}"/>
				<pathelement path="${lwjgl.bin.tests}"/>
			</classpath>
			<xmlfileset dir="config" includes="tests.xml,tests_${lwjgl.platform}.xml"/>
			<jvmarg value="-Djava.library.path=${lwjgl.lib.bin}"/>
		</testng>
	</target>

</project>
